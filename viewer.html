<!DOCTYPE html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  </head>
  <body>
    <div id="map" style="height: 500px; width: 100%"></div>
    <div id="side-panel" style="position: absolute; right: 15px; top: 15px; width: 300px; height: 450px; background-color: green;"></div>

    <script>
      var map;
      var mapMessages = new Object();
      var mapData = new Object();

      function initMap() {
        // Create a map object and specify the DOM element for display.
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 25.045354839491246, lng: 121.5311050415039},
          scrollwheel: true,
          zoom: 16 
        });
        map.addListener('idle', mapDidChanged)
        var styles = {
          hide: [
            {
              featureType: 'poi',
              stylers: [{visibility: 'off'}]
            },
            {
              featureType: 'transit',
              elementType: 'labels.icon',
              stylers: [{visibility: 'off'}]
            }
          ]
        };
        map.setOptions({styles: styles['hide']});
      }

      function mapDidChanged() {
        // getMsgsByGeo();
        // getHotels();
        getDataFromMax();
      }

      function getDataFromMax() {
        var urlStr = "http://10.187.0.151:3000/api/all/" ;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', urlStr);
        xhr.onload = function() {
          if (xhr.status !== 200) {
            alert("/bookings.getHotels failed:\n" + xhr.status + ": " + xhr.responseText);
            return;
          }
          var responseObj = JSON.parse(xhr.responseText);
          var dataArray = responseObj.data;
          dataArray.forEach(function(dataJSON) {
             var dataID = dataJSON["_id"];
             if (!(dataID in mapData)) {
               var dataMarker = googleMapsDataMarker(dataJSON);
               mapData[dataID] = dataMarker;
             }
          });
        }
        xhr.send();
      }

      function getHotels() {
        var urlStr = "http://10.187.0.151:3000/api/booking/all/";  // server request with auth: /bookings.getHotels?city_ids=-2637882
        var xhr = new XMLHttpRequest();
        xhr.open('GET', urlStr);
        xhr.onload = function() {
          if (xhr.status !== 200) {
            alert("/bookings.getHotels failed:\n" + xhr.status + ": " + xhr.responseText);
            return;
          }
          var hotelsArray = JSON.parse(xhr.responseText);
          hotelsArray.forEach(function(hotelJSON) {
            googleMapsHotelMarker(hotelJSON);
          });
        }
        xhr.send();
      }

      function getMsgsByGeo() {
         var centerPoint = map.getCenter();
         var swnePoints = map.getBounds();
         var swPoint = swnePoints.getSouthWest();
         var nePoint = swnePoints.getNorthEast();
         var clat = centerPoint.lat();
         var clng = centerPoint.lng();
         var slat = Math.abs(nePoint.lat() - swPoint.lat());
         var slng = Math.abs(nePoint.lng() - swPoint.lng());

         var values = "";
         values += "clat=" + encodeURIComponent(clat);
         values += "&clng=" + encodeURIComponent(clng);
         values += "&slat=" + encodeURIComponent(slat);
         values += "&slng=" + encodeURIComponent(slng);
         var urlStr = "https://www.jinma.io/MsgsByGeo?" + values;

         var xhr = new XMLHttpRequest();
         xhr.open('GET', urlStr);
         xhr.onload = function() {
           if (xhr.status !== 200) {
             alert("/MsgsByGeo failed:\n" + xhr.status + ": " + xhr.responseText);
             return;
           }
           var responseObj = JSON.parse(xhr.responseText);
           var msgs = responseObj["Msgs"];
           msgs.forEach(function(msgJSON) {
             var msgID = msgJSON.ID;
             if (!(msgID in mapMessages)) {
               var msgMarker = googleMapsMessageMarker(msgJSON);
               mapMessages[msgID] = msgMarker;
             }
           });
         }
         xhr.send();
       }

       function googleMapsDataMarker(dataJSON) {
         var image = 'message-2-32.png'; /* Public domain icon, from http://www.iconsdb.com/soylent-red-icons/message-2-icon.html */
         var lat = parseFloat(dataJSON.lat);
         var lng = parseFloat(dataJSON.lng);
         if (isNaN(lat) || isNaN(lng)) {
           alert("server lat or lng wrong format");
           return;
         }
         var msgMarker = new google.maps.Marker({
           position: {
             lat: lat,
             lng: lng
           },
           map: map,
           icon: image
         });
         var message = "<div style='text-align: left; font-size: 12px'> ";
         message += dataJSON.description;
         message += "</div>";
         var msgMarkerInfoWindow = new google.maps.InfoWindow({
           content: message
         });
         msgMarker.addListener('click', function() {
           msgMarkerInfoWindow.open(map, msgMarker);
         });
           return msgMarker;

       }

       function googleMapsMessageMarker(msgJSON) {
         var image = 'message-2-32.png'; /* Public domain icon, from http://www.iconsdb.com/soylent-red-icons/message-2-icon.html */
         var msgMarker = new google.maps.Marker({
           position: {
             lat: msgJSON.Lat,
             lng: msgJSON.Lng
           },
           map: map,
           icon: image
         });
         var time = new Date();
         time.setTime(msgJSON.Time * 1000); // setTime() in millisecond unit
         var message = "<div style='text-align: left; font-size: 12px'> ";
         message += "<p>(Lat, Lng) = (" + msgJSON.Lat + ", " + msgJSON.Lng + ")<br>";
         message += "Time: " + time + "<br>";
         message += "Username: " + msgJSON.User.Name + "<br>";
         message += "Message: " + msgJSON.Body+ "</p>";
         message += "</div>";
         var msgMarkerInfoWindow = new google.maps.InfoWindow({
           content: message
         });
         msgMarker.addListener('click', function() {
           msgMarkerInfoWindow.open(map, msgMarker);
         });
           return msgMarker;
       }

       function googleMapsHotelMarker(hotelJSON) {
         var image = 'message-2-32.png'; /* Public domain icon, from http://www.iconsdb.com/soylent-red-icons/message-2-icon.html */
         var msgMarker = new google.maps.Marker({
           position: {
             lat: hotelJSON.location.latitude,
             lng: hotelJSON.location.longitude
           },
           map: map,
           icon: image
         });
         msgMarker.addListener('click', function() {
           var sidePanel = document.getElementById("side-panel");
           $("#side-panel").fadeToggle( "fast", "linear", function() {	// old panel disappear
             while (sidePanel.firstChild) {
               sidePanel.removeChild(sidePanel.firstChild);	        // remove old data
             }
             var para = document.createElement('p');
             para.appendChild(document.createTextNode(hotelJSON.name));
             sidePanel.appendChild(para);                               // append new data

             $("#side-panel").fadeToggle( "fast", "linear" );           // new panel appear
           } );
         });
           return msgMarker;
       }


    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key= AIzaSyD3r5tn217etQ0WWDLiDpjhdHqxEwJ5gkI&callback=initMap"
    async defer></script>
  </body>
</html>
