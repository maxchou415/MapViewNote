<!DOCTYPE html>
<html>
  <head>
  </head>
  <body>
    <div id="map" style="height: 400px; width: 100%"></div>
    <script>
      var map;
      var mapMessages = new Object();

      function initMap() {
        // Create a map object and specify the DOM element for display.
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 25.045354839491246, lng: 121.5311050415039},
          scrollwheel: true,
          zoom: 16 
        });
        map.addListener('idle', mapDidChanged)
      }

      function mapDidChanged() {
        getMsgsByGeo();
        getHotels();
      }

      function getHotels() {
        var urlStr = "https://distribution-xml.booking.com/json/bookings.getHotels?city_ids=-2637882";
        var xhr = new XMLHttpRequest();
        xhr.open('GET', urlStr);
        xhr.setRequestHeader("Authorization", "Basic " + btoa("hacker234:8hqNW6HtfU"));
        xhr.onload = function() {
          if (xhr.status !== 200) {
            alert("/bookings.getHotels failed:\n" + xhr.status + ": " + xhr.responseText);
            return;
          }
          var hotelsArray = JSON.parse(xhr.responseText);
          hotelsArray.forEach(function(hotelJSON) {
            googleMapsHotelMarker(hotelJSON);
          });
        }
        xhr.send();
      }

      function getMsgsByGeo() {
         var centerPoint = map.getCenter();
         var swnePoints = map.getBounds();
         var swPoint = swnePoints.getSouthWest();
         var nePoint = swnePoints.getNorthEast();
         var clat = centerPoint.lat();
         var clng = centerPoint.lng();
         var slat = Math.abs(nePoint.lat() - swPoint.lat());
         var slng = Math.abs(nePoint.lng() - swPoint.lng());

         var values = "";
         values += "clat=" + encodeURIComponent(clat);
         values += "&clng=" + encodeURIComponent(clng);
         values += "&slat=" + encodeURIComponent(slat);
         values += "&slng=" + encodeURIComponent(slng);
         var urlStr = "https://www.jinma.io/MsgsByGeo?" + values;

         var xhr = new XMLHttpRequest();
         xhr.open('GET', urlStr);
         xhr.onload = function() {
           if (xhr.status !== 200) {
             alert("/MsgsByGeo failed:\n" + xhr.status + ": " + xhr.responseText);
             return;
           }
           var responseObj = JSON.parse(xhr.responseText);
           var msgs = responseObj["Msgs"];
           msgs.forEach(function(msgJSON) {
             var msgID = msgJSON.ID;
             if (!(msgID in mapMessages)) {
               var msgMarker = googleMapsMessageMarker(msgJSON);
               mapMessages[msgID] = msgMarker;
             }
           });
         }
         xhr.send();
       }

       function googleMapsMessageMarker(msgJSON) {
         var image = 'message-2-32.png'; /* Public domain icon, from http://www.iconsdb.com/soylent-red-icons/message-2-icon.html */
         var msgMarker = new google.maps.Marker({
           position: {
             lat: msgJSON.Lat,
             lng: msgJSON.Lng
           },
           map: map,
           icon: image
         });
         var time = new Date();
         time.setTime(msgJSON.Time * 1000); // setTime() in millisecond unit
         var message = "<div style='text-align: left; font-size: 12px'> ";
         message += "<p>(Lat, Lng) = (" + msgJSON.Lat + ", " + msgJSON.Lng + ")<br>";
         message += "Time: " + time + "<br>";
         message += "Username: " + msgJSON.User.Name + "<br>";
         message += "Message: " + msgJSON.Body+ "</p>";
         message += "</div>";
         var msgMarkerInfoWindow = new google.maps.InfoWindow({
           content: message
         });
         msgMarker.addListener('click', function() {
           msgMarkerInfoWindow.open(map, msgMarker);
         });
           return msgMarker;
       }

       function googleMapsHotelMarker(hotelJSON) {
         var image = 'message-2-32.png'; /* Public domain icon, from http://www.iconsdb.com/soylent-red-icons/message-2-icon.html */
         var msgMarker = new google.maps.Marker({
           position: {
             lat: hotelJSON.location.latitude,
             lng: hotelJSON.location.longitude
           },
           map: map,
           icon: image
         });
         var message = "<div style='text-align: left; font-size: 12px'> ";
         message += "Name: " + hotelJSON.name;
         message += "</div>";
         var msgMarkerInfoWindow = new google.maps.InfoWindow({
           content: message
         });
         msgMarker.addListener('click', function() {
           msgMarkerInfoWindow.open(map, msgMarker);
         });
           return msgMarker;
       }


    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key= AIzaSyD3r5tn217etQ0WWDLiDpjhdHqxEwJ5gkI&callback=initMap"
    async defer></script>
  </body>
</html>
