<!DOCTYPE html>
<html>
  <head>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <style>
      .modal-header {
        border-bottom:0px
      }

      .modal-footer {
        border-top:0px
      }

      input[type="file"] {
        visibility: hidden;
      }

      .photos-file-upload {
        cursor: pointer;
        text-align: center;
        min-width: 100%;
      }

      #preview {
        text-align: center;
        max-width: 100%;
        max-height: 205px;
      }

      #modal-upload {
        border-radius: 24px;
        padding-left: 25px;
        padding-right: 25px;
        background-color: #ef4445;
        border-color: #ef4445;
      }

      #modal-upload:hover, #modal-upload:focus, #modal-upload:active {
        background-color: #ab3131;
        border-color: #ab3131; /*set the color you want here*/
      }

      #desc {
        border-width: 0px;
        min-width: 100%;
        min-height: 100px;
        padding:0 5px 100px;
      }
    </style>
  </head>
  <body>
    <div id="header" style="width: 100%; height: 63px; background-color: #4A4A4A; text-align: center">
      <div id="title" style="margin: 0 auto; padding-top: 14px; color: white; font-family: Helvetica Neue; font-size: 24px; font-weight: bold">Journey <span style="color: #e82c36">NoteMap<span></div>
    </div>
    <div id="map" style="height: 600px; width: 100%"></div>
    <div id="side-panel" style="position: absolute; right: 15px; top: 85px; width: 471px; height: 555px; background-image: url('note_bg.png');"></div>
    <div id="footer" style="position: relative; width: 100%; height: 106px; background-color: #4A4A4A">
      <button data-toggle="modal" data-target="#myModal" style="position: absolute; bottom: 0; left: 45%; width: 113px; height: 130px; background-color: #e82c36; color: white; font-family: Helvetica Neue;"><span style="font-size: 60px">+</span><br><span style="font-size: 24px; font-weight: bold; font-family: Avenir Next">Add</span></button>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="upload" class="" action="http://10.187.0.151:3000/api/create" method="post" enctype="multipart/form-data">
              <label for="photos" class="photos-file-upload">
                <img id="preview" src="upload_photo.png" />
              </label>
              <input id="photos" type="file" name="photos" onchange="readURL(this);" />

              <input id="desc" type="text" name="description" placeholder="Add your note here..." />
              <input type="text" name="lng" placeholder="lng" style="display: none" />
              <input type="text" name="lat" placeholder="lat" style="display: none" />

            </form>
          </div>
          <div class="modal-footer">
            <!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> -->
            <button id="modal-upload" type="button" class="btn btn-primary" data-loading-text="Loading...">Submit</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      var map;
      var mapMessages = new Object();
      var mapData = new Object();

      function initMap() {
        // Create a map object and specify the DOM element for display.
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 25.045354839491246, lng: 121.5311050415039},
          scrollwheel: true,
          zoom: 16
        });
        map.addListener('idle', mapDidChanged)
        var styles = {
          hide: [
            {
              featureType: 'poi',
              stylers: [{visibility: 'off'}]
            },
            {
              featureType: 'transit',
              elementType: 'labels.icon',
              stylers: [{visibility: 'off'}]
            }
          ]
        };
        map.setOptions({styles: styles['hide']});
      }

      function mapDidChanged() {
        // getMsgsByGeo();
        getHotels();
        // getDataFromMax();
      }

      function getDataFromMax() {
        var urlStr = "http://128.199.103.142:3000/api/all/" ;
        var xhr = new XMLHttpRequest();
        xhr.open('GET', urlStr);
        xhr.onload = function() {
          if (xhr.status !== 200) {
            alert("/bookings.getHotels failed:\n" + xhr.status + ": " + xhr.responseText);
            return;
          }
          var responseObj = JSON.parse(xhr.responseText);
          var dataArray = responseObj.data;
          dataArray.forEach(function(dataJSON) {
             var dataID = dataJSON["_id"];
             if (!(dataID in mapData)) {
               var dataMarker = googleMapsDataMarker(dataJSON);
               mapData[dataID] = dataMarker;
             }
          });
        }
        xhr.send();
      }

      function getHotels() {
        var urlStr = "http://128.199.103.142:3000/api/booking/all/";  // server request with auth: /bookings.getHotels?city_ids=-2637882
        var xhr = new XMLHttpRequest();
        xhr.open('GET', urlStr);
        xhr.onload = function() {
          if (xhr.status !== 200) {
            alert("/bookings.getHotels failed:\n" + xhr.status + ": " + xhr.responseText);
            return;
          }
          var hotelsArray = JSON.parse(xhr.responseText);
          hotelsArray.forEach(function(hotelJSON) {
            googleMapsHotelMarker(hotelJSON);
          });
        }
        xhr.send();
      }

      function getMsgsByGeo() {
         var centerPoint = map.getCenter();
         var swnePoints = map.getBounds();
         var swPoint = swnePoints.getSouthWest();
         var nePoint = swnePoints.getNorthEast();
         var clat = centerPoint.lat();
         var clng = centerPoint.lng();
         var slat = Math.abs(nePoint.lat() - swPoint.lat());
         var slng = Math.abs(nePoint.lng() - swPoint.lng());

         var values = "";
         values += "clat=" + encodeURIComponent(clat);
         values += "&clng=" + encodeURIComponent(clng);
         values += "&slat=" + encodeURIComponent(slat);
         values += "&slng=" + encodeURIComponent(slng);
         var urlStr = "https://www.jinma.io/MsgsByGeo?" + values;

         var xhr = new XMLHttpRequest();
         xhr.open('GET', urlStr);
         xhr.onload = function() {
           if (xhr.status !== 200) {
             alert("/MsgsByGeo failed:\n" + xhr.status + ": " + xhr.responseText);
             return;
           }
           var responseObj = JSON.parse(xhr.responseText);
           var msgs = responseObj["Msgs"];
           msgs.forEach(function(msgJSON) {
             var msgID = msgJSON.ID;
             if (!(msgID in mapMessages)) {
               var msgMarker = googleMapsMessageMarker(msgJSON);
               mapMessages[msgID] = msgMarker;
             }
           });
         }
         xhr.send();
       }

       function googleMapsDataMarker(dataJSON) {
         var image = dataJSON.imageURL;
         var lat = parseFloat(dataJSON.lat);
         var lng = parseFloat(dataJSON.lng);
         if (isNaN(lat) || isNaN(lng)) {
           alert("server lat or lng wrong format");
           return;
         }
         var msgMarker = new google.maps.Marker({
           position: {
             lat: lat,
             lng: lng
           },
           map: map,
           icon: image
         });
         msgMarker.addListener('click', function() {
           var sidePanel = document.getElementById("side-panel");
           $("#side-panel").fadeToggle( "fast", "linear", function() {	// old panel disappear
             while (sidePanel.firstChild) {
               sidePanel.removeChild(sidePanel.firstChild);	        // remove old data
             }
             var para = document.createElement('p');
             para.appendChild(document.createTextNode(dataJSON.name));
             sidePanel.appendChild(para);                               // append new data

             $("#side-panel").fadeToggle( "fast", "linear" );           // new panel appear
           });
         });
           return msgMarker;
       }

       function googleMapsMessageMarker(msgJSON) {
         var image = 'message-2-32.png'; /* Public domain icon, from http://www.iconsdb.com/soylent-red-icons/message-2-icon.html */
         var msgMarker = new google.maps.Marker({
           position: {
             lat: msgJSON.Lat,
             lng: msgJSON.Lng
           },
           map: map,
           icon: image
         });
         var time = new Date();
         time.setTime(msgJSON.Time * 1000); // setTime() in millisecond unit
         var message = "<div style='text-align: left; font-size: 12px'> ";
         message += "<p>(Lat, Lng) = (" + msgJSON.Lat + ", " + msgJSON.Lng + ")<br>";
         message += "Time: " + time + "<br>";
         message += "Username: " + msgJSON.User.Name + "<br>";
         message += "Message: " + msgJSON.Body+ "</p>";
         message += "</div>";
         var msgMarkerInfoWindow = new google.maps.InfoWindow({
           content: message
         });
         msgMarker.addListener('click', function() {
           msgMarkerInfoWindow.open(map, msgMarker);
         });
           return msgMarker;
       }

       function googleMapsHotelMarker(hotelJSON) {
         var image = 'booking.png';
         var msgMarker = new google.maps.Marker({
           position: {
             lat: hotelJSON.location.latitude,
             lng: hotelJSON.location.longitude
           },
           map: map,
           icon: image
         });
         var message = "<div style='width: 433px; height: 149px;'> ";
         message += "<span style='display: block; position: absolute; left: 247px; top: 15px; font-size: 20px; font-weight: bold; font-family: Avenir Next;'>"+ hotelJSON.name +"</span>";
         message += "<button style='display: block; position: absolute; left: 212px; top: 100px; width: 144px; height: 40px; border-radius: 20px; font-size: 16px; font-family: Avenir Next; color: white; background-color: #0F347E' type='button' class='btn btn-default'  onclick='window.location.href=\"" + hotelJSON.url +"\"'>Booking Now</button>";
         message += "<img style='display: block; position: absolute; left: 6px; top: 12px; height: 128px' src='1475796.jpg'>";
         message += "<img style='display: block; position: absolute; left: 213px; top: 15px; height: 26px' src='booking.png'>";
         message += "</div>";
         var msgMarkerInfoWindow = new google.maps.InfoWindow({
           content: message
         });
         msgMarker.addListener('click', function() {
           msgMarkerInfoWindow.open(map, msgMarker);
         });
           return msgMarker;
                }

          function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();

                reader.onload = function (e) {
                    $('#preview')
                        .attr('src', e.target.result)
                        .attr("style", "visibility: visible");
                };

                reader.readAsDataURL(input.files[0]);
            }
          }
          // $('#photos').change(function(){
          //   var input = $('#photos');
          //   console.log(input.val());
          //   if (input.files && input.files[0]) {
          //     var reader = new FileReader();
          //
          //     reader.onload = function (e) {
          //       $('#preview').attr('src', e.target.result);
          //       console.log("111");
          //     }
          //
          //     reader.readAsDataURL(input.files[0]);
          //   }
          // });
          $('#modal-upload').on('click', function () {
            var $btn = $(this).button('loading')
          })

          $("#modal-upload").click(function(data){
            var form = new FormData($("#upload")[0]);
            console.log(form)
            $.ajax({
                    url: 'http://10.187.0.151:3000/api/create',
                    method: "POST",
                    dataType: 'json',
                    data: form,
                    processData: false,
                    contentType: false,
                    success: function(result){
                      if(!result) {

                      } else {
                        $('#myModal').modal('hide')
                      }
                    },
                    error: function(er){
                      console.log(er)
                    }
            });
          });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key= AIzaSyD3r5tn217etQ0WWDLiDpjhdHqxEwJ5gkI&callback=initMap"
    async defer></script>
  </body>
</html>
